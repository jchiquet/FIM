---
title: "Computing  an empirical  Fisher information matrix estimate in latent variable models through stochastic approximation"
author:
  - name: "Maud Delattre"
    affiliation: Université Paris-Saclay, INRAE, MaIAGE, 78350, Jouy-en-Josas, France
  - name: "Estelle Kuhn"
    affiliation: Université Paris-Saclay, INRAE, MaIAGE, 78350, Jouy-en-Josas, France
date: last-modified
abstract: >+
  The Fisher information matrix (FIM) is a key quantity in statistics. However its exact computation is often not trivial. In particular in many latent variable models, it is intricated due to the presence of unobserved variables. Several methods have been proposed to approximate the  FIM when it can not be evaluated analytically.  Different  estimates have been considered, in particular moment estimates. However some of them require to compute second derivatives of the complete data log-likelihood which leads to some disadvantages. In this paper, we focus on the empirical Fisher information matrix defined as an empirical estimate of the covariance matrix of the score, which only requires to compute the first derivatives of the log-likelihood. Our contribution consists in presenting a new numerical method to evaluate this empirical Fisher information matrix in latent variable model when the proposed estimate can not be directly analytically evaluated. We propose a stochastic approximation estimation algorithm to compute this estimate as a by-product of the parameter estimate. We evaluate the finite sample size properties of the proposed estimate and the convergence properties of the estimation algorithm through simulation studies. 
citation:
  type: article-journal
  container-title: "Computo"
  doi: "xxxx"
  url: https://computo.sfds.asso.fr/template-computo-quarto
github: https://github.com/computorg/template-computo-quarto
bibliography: references.bib
repo: "template-computo-quarto"
execute:
  warning: false
  message: false
---

[![build status](https://github.com/computorg/{{< meta repo >}}/workflows/build/badge.svg)](https://github.com/computorg/{{< meta repo >}})
[![Creative Commons License](https://i.creativecommons.org/l/by/4.0/80x15.png)](http://creativecommons.org/licenses/by/4.0/)




```{r}
#| label: loadlibrary
#| echo: false
library(dplyr)
library(flextable)
library(magrittr)
library(ggplot2)
library(cowplot)
library(RColorBrewer)
library(devtools)
library(lme4)
```


# Introduction

The Fisher information matrix (FIM) is a key quantity in statistics as it is required for examples  for evaluating asymptotic precisions of parameter estimates, for building  optimality criteria in experimental designs, for computing Wald test statistics  or classical asymptotic distributions in statistical testing [@VanderVaart2000]. It also appears more recently in post model selection inference [@charkhi2018asymptotic], in asymptotic distribution of the likelihood ratio test statistics when testing variance component in mixed models [@baey2019asymptotic] or  as a particular Riemannian metric on complex manifold [@le2021fisher]. However its exact computation is often not trivial. This is in particular the case in many latent variables models,  also called incomplete data models, due to the presence of the unobserved variables. Though these models are increasingly used in many fields of application, such as in ecophysiology [@Technow2015], in genomic [@Picard2007] or in ecology [@Gloaguen2014]. They especially allow a better consideration of the different variability sources and when appropriate, a more precise characterization of the known mechanisms at the origin of the data. When the FIM can not be exactly computed, people either approximate it numerically, for example by using Monte Carlo technics like developed in the R package MIXFIM [@mixfim2018] or focus on an estimate of the FIM. The probably most widely used  is the observed FIM [@efron1978assessing].  When  it can not be directly computed in latent variable models, several methods have  been proposed to approximate it. Among the most frequently used approaches are Monte-Carlo methods or iterative algorithms derived from the missing information principle [@Woodbury1972]. Indeed according to this principle, the observed Fisher information matrix can be expressed as the difference between two matrices corresponding to the complete information and the missing information due to the unobserved variables (see *e.g.* [@McLachlan2008] chapter 4). It enables the development of alternative methods to compute the observed FIM: the Louis's method [@Louis1982], combined with a Monte Carlo method or a stochastic approximation algorithm by [@Delyon1999], the Oakes method [@Oakes1999] or the supplemented Expectation Maximization algorithm [@Meng1991].  However as the observed FIM involves the second derivatives of the observed log-likelihood, all these methods require to compute second derivatives of the complete data log-likelihood which leads to some disadvantages from a computational point of view. More recently, [@Meng2017] proposed an accelerated algorithm based on numerical first order derivatives of the conditional expectation of the log-likelihood. Another estimate is the empirical Fisher information matrix. This estimator of the FIM is defined as the moment estimate of the covariance matrix of the score. It is  much less used  than the observed Fisher information matrix. However it has a nice property since it is positive definite, which is not systematically the case for the latter and  it is numerically more interesting because it  only requires the calculation of the first derivatives of the log-likelihood.


In this paper, our contribution consists in presenting a new numerical method to evaluate the empirical FIM in latent variables model. 
Indeed, when the proposed estimate can not be directly analytically evaluated, we propose a stochastic approximation estimation algorithm to compute  it, which  provides this estimate of the FIM as a by-product of model parameter estimates. 


The paper is organized as follows. In Section 2, we recall the three main FIM estimates  and discuss their immediate properties. In Section 3, we give practical tools for the computation of the empirical  Fisher information matrix in incomplete data models. In particular, we introduce a new stochastic approximation procedure based on the first derivatives of the complete log-likelihood only and state its asymptotic properties. In Section 4, we illustrate the finite sample size properties of both estimators and the convergence properties of the computation algorithm through simulations. The paper ends by a discussion.

# Moment estimates of the Fisher information matrix

Let us consider a random variable $Y$.  Assume $Y$ admits a density $g$ with respect to a given measure depending on some parameter $\theta$ taking values in an open subset $\Theta$ of $\mathbb{R}^{d}$, such that the log-likelihood function $\log g$ is differentiable on $\Theta$ and that $\|\partial_\theta  \log g(y;\theta) (\partial_\theta  \log g(y;\theta))^t\|$ is integrable, where $x^t$ stands for the transpose of a vector or a matrix $x$. Then, by definition, the Fisher information matrix is given for all $\theta\in\Theta$ by:
$$
I(\theta) =  E_\theta\left[\partial_\theta \log g(Y;\theta) (\partial_\theta \log g(Y;\theta))^t \right].
$$ {#eq-fisher_der1}
When this expression can not be analytically evaluated, people are interested in computing an estimate of the Fisher information matrix.
Considering this expression, one can derive a first moment estimator of the Fisher information matrix based on a $n$-sample $(y_1, \ldots, y_{n})$ of observations:
$$
I_{n,sco}(\theta) = \frac{1}{n} \sum_{i=1}^n \partial_\theta \log g(y_i;\theta) (\partial_\theta \log g(y_i;\theta))^t.
$$ {#eq-isco}
This estimate is indeed equal to the mean of the Gram matrices of the scores. One can also derive a second estimate from @eq-fisher_der1 defined as
$$
I_{n,cov}(\theta) = \frac{1}{n} \sum_{i=1}^n \partial_\theta \log g(y_i;\theta) (\partial_\theta \log g(y_i;\theta))^t-\bar{s}\bar{s}^t,
$$
where $\bar{s}=\frac{1}{n}\sum_{i=1}^n \partial_\theta \log g(y_i;\theta)$ (see *e.g.* [@Scott2002]).	We emphasize here that the terminology "empirical Fisher information matrix" is used  in the literature for both estimates (see *e.g.* [@kunstner2019limitations]).

If the log-likelihood function $\log g$ is twice differentiable on $\Theta$, the following relation also holds for all $\theta \in \Theta$:
$$
I(\theta) =  - E_\theta\left[\partial_\theta^2 \log g(Y;\theta) \right].
$$ {#eq-fisher_der2}

Considering this second expression, we can derive another moment estimator of  the Fisher information matrix based on a $n$-sample $(y_1, \ldots, y_{n})$ of observations, called the observed Fisher information matrix defined as:
$$
I_{n,obs}(\theta) = - \frac{1}{n} \sum_{i=1}^n \partial_\theta^2 \log g(y_i;\theta).
$$ {#eq-iobs}

::: {.remark}
We emphasize that the estimate $I_{n,sco}(\theta)$ is always positive definite, since it is a mean of Gram matrices, contrary to the others estimates $I_{n,obs}(\theta)$ and $I_{n,cov}(\theta)$.
:::

::: {.remark}
The asymptotical properties of the estimates $I_{n,sco}(\theta)$ and $I_{n,obs}(\theta)$ are straighforward when considering independent and identically distributed sample $(y_1, \ldots, y_{n})$. In particular, assuming standard regularity conditions on $g$, it follows directly from the  central limit theorem that $I_{n,sco}(\theta)$ and $I_{n,obs}(\theta)$ are asymptotically normal. 
:::

::: {.remark}
Since both estimators  $I_{n,sco}(\theta)$ and $I_{n,obs}(\theta)$ are moment estimates of $I(\theta)$, they are unbiased for all $\theta \in \Theta$. This is not the case for $I_{n,cov}(\theta)$. Regarding the variance, none of both estimators is better than the other one. This can be highlighted through the following examples. First consider a Gaussian sample with unknown expectation and fixed variance. Then, the variance of the estimator $I_{n,obs}(\theta)$ is zero whereas the variance of the estimator $I_{n,sco}(\theta)$ is positive. Second consider a centered Gaussian sample with unknown variance. Then, the variance of $I_{n,sco}(\theta)$ is smaller than the variance of $I_{n,obs}(\theta)$. Therefore, none of both estimators is more suitable than the other in general from this point of view. 
:::

If the variables $Y_1, \ldots, Y_{n}$ are not identically distributed, for example if they depend on some individual covariates which is often the case, we state the following result under the less restrictive assumption of  independent non identically distributed random variables.

::: {#prp-prop1}
Assume that $Y_1, \ldots, Y_{n}$ are independent non identically distributed random variables each having a parametric probability density function $g_i$ depending on some common parameter $\theta$ in  an open subset $\Theta$ of $\mathbb{R}^p$. Assume also that for all $i$ the function $\log g_i$ is differentiable in $\theta$ on $\Theta$ and that for all $\theta \in \Theta$, $\partial_\theta \log g_i(y;\theta) (\partial_\theta \log g_i(y;\theta))^t$ is integrable. Moreover assume that for all $\theta$   in $\Theta$, $\lim \frac1{n} \displaystyle\sum_{i=1}^n E_\theta(\partial_\theta \log g_i(y;\theta) (\partial_\theta \log g_i(y;\theta))^t)$ exists and denote it by $\nu(\theta)$.
Then, for all $\theta \in \Theta$, the  estimator $I_{n,sco}(\theta)$ is defined, converges almost surely toward $\nu(\theta)$  and is asymptotically normal. 
Assuming additionaly that $\log g_i$ is twice differentiable in $\theta$ on $\Theta$, the   estimator $I_{n,obs}(\theta)$ is defined, converges almost surely toward $\nu(\theta)$  and is  asymptotically normal.
:::


::: {.proof}
We prove the consistency by applying the law of large numbers for non identically distributed variables. We establish the normality result by using characteristic functions. By recentering the terms $E_\theta(\partial_\theta \log g_i(y;\theta) (\partial_\theta \log g_i(y;\theta))^t)$, we can assume that $\nu(\theta)$ equals zero. Let us denote by $\phi_Z$ the characteristic function for a random variable $Z$. We have for all real $t$ in a neighborhood of zero that:
$$
\begin{split}
\| \phi_{I_{n,sco}(\theta)/ \sqrt{n}}(t)-1 \| & = \|  \prod_{i=1}^n (\phi_{\partial_\theta \log g_i(y;\theta) (\partial_\theta \log g_i(y;\theta))^t}(t/n)-1) \| \\
& \leq   \prod_{i=1}^n \|  \phi_{\partial_\theta \log g_i(y;\theta) (\partial_\theta \log g_i(y;\theta))^t}(t/n)-1 \| 
\end{split}
$$
Computing a limited expansion in $t$ around zero, we get the result.

Noting that for all $1 \leq  i \leq n$, $E_\theta(\partial_\theta \log g_i(y;\theta) (\partial_\theta \log g_i(y;\theta))^t)=-E_\theta(\partial_\theta^2 \log g_i(y;\theta))$, we get the corresponding results for the estimator $I_{n,obs}(\theta)$.
:::

::: {.remark}
The additional assumptions required when considering non identically distributed random variables are in the same spirit as  those usually used in the literature. Let us quote for example [@Nie2006], [@Silvapulle2011], [@baey2019asymptotic].
:::

# Computing the  estimator $I_{n,sco}(\theta)$ in latent variable model

Let us consider independent random variables $Y_1, \ldots, Y_{n}$. Assume in the sequel that there exist independent random variables $Z_1, \ldots, Z_{n}$ such that for each $1 \leq  i \leq  n$, the random vector  $(Y_i,Z_i)$ admits a   parametric probability density function denoted by $f$ parametrized by $\theta \in \Theta$. We present in this section dedicated tools to compute the estimator $I_{n,sco}(\theta)$ in latent variable model when it can not be evaluated analytically.

## Analytical expressions in latent variable models


In  latent variable models, the estimator $I_{n,sco}(\theta)$ can be expressed using the conditional expectation as  stated in the following proposition.

::: {#prp-fisherequality}
Assume that for all $\theta \in\Theta$ the function $\log g(\cdot;\theta)$ is integrable, that for all $y$ the function $\log g(y;\cdot)$ is   differentiable on $\Theta$ and  that there exists an integrable function $m$ such that for all  $\theta \in\Theta$, $\|\ \partial_\theta \log g(y;\theta) \| \leq m(y)$. Then for all $\theta \in \Theta$ and all $n \in \mathbb{N}^*$:
$$
I_{n,sco}(\theta) = \frac{1}{n} \sum_{i=1}^n \mathrm{E}_{Z_i|Y_i;\theta} (\partial_\theta \log f(Y_i,Z_i;\theta) ) \mathrm{E}_{Z_i|Y_i;\theta} (\partial_\theta \log f(Y_i,Z_i;\theta) )^t, 
$$ {#eq-vnmis}

where $\mathrm{E}_{Z|Y;\theta}$ denotes the expectation under the law of $Z$ conditionally to $Y$.
:::

We apply the classical Fisher identity [@fisher1925] to  establish the equality stated in Proposition @prp-fisherequality.
This statement  is indeed in the same spirit  as the well-known Louis formulae for the observed Fisher information matrix estimate [@Louis1982].

::: {.remark}
In some specific cases  the conditional expectations involved in the previous proposition  admit exact analytical expressions for example  in mixture models which are  developed in @sec-simul in some simulation studies. 
:::

## Computing $I_{n,sco}(\theta)$ using stochastic approximation algorithm

When exact computation of the estimator $I_{n,sco}(\theta)$ is not possible, we propose  to evaluate its value by using a stochastic algorithm which provides the estimate $I_{n,sco}(\theta)$ as a by-product of the parameter estimates of $\theta$.  

### Description of the algorithm in curved exponential family model {#sec-algoSAEM}

We consider an extension of the stochastic approximation Expectation Maximization algorithm proposed by [@Delyon1999] which allows to compute the maximum likelihood estimate in general latent variables model. We assume that the complete log-likelihood belongs to the curved exponential family  for stating the theoretical results. However our algorithm can be easily extended to general latent variables models (see @sec-generalmodel). As our estimate involves individual conditional expectations, we have to consider an extended form of sufficient  statistics for the model. Therefore we  introduce the following notations and assumptions.

The individual complete data likelihood function is given for all $1 \leq  i \leq  n$ by:
$$
f_i(z_i;\theta) = \exp\left(-\psi_i(\theta) + \left<S_i(z_i),\phi_i(\theta)\right>\right),
$$ {#eq-curvedexpo}
where $\left<\cdot,\cdot\right>$ denotes the scalar product, $S_i$ is a function on $\mathbb{R}^{d_i}$  taking its values in a subset $\mathcal{S}_i$ of $\mathbb{R}^{m_i}$. 

Let us denote  for all $1 \leq  i \leq  n$ by  $L_i$ the function defined on $\mathcal{S}_i \times \Theta$ by $L_i(s_i; \theta)\triangleq - \psi_i(\theta) + \left<s_i,\phi_i(\theta)\right>$ and by $L: \mathcal{S} \times \Theta \to \mathbb{R}$ the function defined as $L(s,\theta)=\sum_i L_i(s_i; \theta)$ with $\mathcal{S}=\prod_i \mathcal{S}_i$ and $s=(s_1,\ldots,s_n)$.
For sake of simplicity, we omitted here all dependency on the observations $(y_i)_{1 \leq  i \leq  n}$  since the considered stochasticity relies on the latent variables.

Finally let us denote by $(\gamma_k)_{k \geq 1}$ a sequence of positive step sizes. 

Moreover we assume that there exists a function $\widehat{\theta} : \ \mathcal{S} \rightarrow \Theta$, such that $\forall s \in \mathcal{S}, \ \  \forall \theta \in \Theta, \ \ L(s; \widehat{\theta}(s))\geq L(s; \theta).$

- **Initialization step**: Initialize arbitrarily for all $1 \leq i \leq n$ $s_i^0$ and $\theta_0$. 
- **Repeat until convergence the  three   steps defined at iteration $k$ by**:
-  **Simulation  step**:  for $1 \leq i \leq n$ simulate a realization  $Z_i^k$ from  the conditional distribution given the observations $Y_i$ denoted by $p_i$ using  the current parameter value $\theta_{k-1}$. 
- **Stochastic approximation step**: compute the quantities for all  $1 \leq i \leq n$
$$
s_i^{k} = (1-\gamma_k)s_i^{k-1} +\gamma_k  S_i(Z_i^k) 
$$
where $(\gamma_k)$ is a sequence of positive step sizes satisfying $\sum \gamma_k=\infty$ and $\sum \gamma_k^2 <~\infty$.


- **Maximisation step**: update  of the parameter estimator  according to:
$$
\theta_{k} = \argmax_{\theta}  \sum_{i=1}^n \left( -\psi_i(\theta) + \left<s_i^k,\phi_i(\theta)\right>\right) = \hat{\theta}(s^{k})
$$
- **When convergence is reached, say  at iteration $K$ of the algorithm, evaluate the FIM estimator according to**:
$$
I_{n,sco}^K = \frac{1}{n} \sum_{i=1}^n \hat{\Delta}_i\left(\hat{\theta}\left(s^{K}\right)\right) \hat{\Delta}_i\left(\hat{\theta}\left(s^{K}\right)\right)^t
$$
where $\hat{\Delta}_i(\hat{\theta}(s))  =  -\partial \psi_i(\hat{\theta}(s)) + \left<s_i,\partial \phi_i(\hat{\theta}(s))\right>$ for all $s$.

::: {.remark}
In the cases where the latent variables can not be simulated from the conditional distribution, one can apply the extension coupling the stochastic algorithm with a Monte Carlo Markov Chain procedure as presented in [@Kuhn2004]. All the following results can be extended to this case.
:::

### Theoretical convergence properties

In addition to the exponential family assumption for each individual likelihood, we also make the same type of regularity assumptions as those presented  in [@Delyon1999] at each individual level. These assumptions are detailed in the appendix section.

::: {#thm-conv.algo}
Assume that $(M1')$ and  $(M2')$,  $(M3)$ to  $(M5)$ and $(SAEM1)$ to $(SAEM4)$  are fulfilled. Assume also that with probability 1 $\mathrm{clos}(\{s_k\}_{k \geq 1})$ is a compact subset of $\mathcal{S}$. Let us define $\mathcal{L}=\{\theta \in\Theta, \partial_\theta l(y;\theta)=0\}$  the set of stationary points of the observed log-likelihood $l$. Then, for all $\theta_0 \in \Theta$, for fixed $n \in \mathbb{N}^*$, we get: $\lim_k d(\theta_k,\mathcal{L})=0$ and  $\lim_k d(I_{n,sco}^k,\mathcal{I})=0$ where $\mathcal{I}=\{I(\theta), \theta \in \mathcal{L}\}$.
:::

::: {.proof}
Let us denote by $S(Z)=(S_1(Z_1),\ldots,S_n(Z_n))$ the sufficient statistics of the model we consider in our approach. Note as recalled in [@Delyon1999], these are not unique. Let us also define $H(Z,s)=S(Z)-s$ and $h(s)=\mathrm{E}_{Z|Y;\theta}(S(Z))-s$.
Assumptions $(M1')$ and $(M2')$  imply that assumptions  $(M1)$ and $(M2)$ of Theorem 5 of [@Delyon1999] are  fulfilled. Indeed these assumptions focus on expressions and regularity properties of the individual likelihood functions and the corresponding sufficient statistics for each index $i \in \{1,\ldots,n\}$. Then by linearity of the log-likelihood function and of the stochastic approximation and applying Theorem 5 of [@Delyon1999], we get that $\lim_k d(\theta_k,\mathcal{L})=0$. 
Moreover we get that for $1 \leq i \leq n$, each sequence $(s_i^k)$ converges almost surely toward $\mathrm{E}_{Z_i|Y_i;\theta} (S_i(Z_i) )$.
Since  assumption $(M2')$ ensures that for all $1 \leq i \leq n$ the functions $\psi_i$ and $\phi_i$ are twice continuously differentiable and assumption $(M5)$ ensures that the function $\hat{\theta}$ is continuously differentiable, the function $\Phi_n$ defined by $\Phi_n(s^{k})=\frac1{n}\sum_{i=1}^n \hat{\Delta}_i(\hat{\theta}(s^{k}))\hat{\Delta}_i(\hat{\theta}(s^{k}))$ is continuous. Therefore  we get that $\lim_k d(I_{n,sco}^k,\mathcal{I})=0$.
:::


We now establish the asymptotic normality of the estimate $\bar{I}_{n,sco}^k$ defined as $\bar{I}_{n,sco}^k=\Phi_n(\bar{s}^{k})$ with $\bar{s}^{k}=\sum_{l=1}^k s^l /k$ using the results stated by [@Delyon1999].  Let us denote by $Vect(A)$ the vector composed of the elements of the triangular superior part of matrix $A$ ordered by columns.

::: {#thm-conv2}
Assume that $(M1')$ and  $(M2')$,  $(M3)$ to  $(M5)$, $(SAEM1')$,  $(SAEM2)$,  $(SAEM3)$,  $(SAEM4')$ and $(LOC1)$ to $(LOC3)$ are fulfilled.  Then, there exists a regular stable stationary point $\theta^* \in \Theta$ such that $\lim_k \theta_k=\theta^*$ a.s. Moreover  the sequence $(\sqrt{k}(Vect(\bar{I}_{n,sco}^k)-Vect(\bar{I}_{n,sco}(\theta^*))))\mathbb{1}_{\lim \| \theta_k-\theta^*\|=0 }$ converges in distribution toward a centered Gaussian random vector  when $k$ goes to infinity. The asymptotic covariance matrix is characterised.  
:::

::: {.proof}
The proof follows the lines of this of Theorem 7 of [@Delyon1999]. 
Assumptions $(LOC1)$ to $(LOC3)$ are those of [@Delyon1999] and  ensure the existence of a regular stable stationary point $s^*$ for $h$ and therefore of $\theta^*=\hat{\theta}(s^*)$ for the observed log-likelihood $l$. Then applying Theorem 4 of [@Delyon1999], we get that:
$$
\sqrt{k}( \bar{s}^k - s^*) \mathbb{1}_{\lim \| s^k-s^*\|=0 } \overset{\mathcal{L}}{ \rightarrow} \mathcal{N}(0, J(s^*)^{-1}  \Gamma(s^*) J(s^*)^{-1}  )\mathbb{1}_{\lim \| s_k-s^*\|=0 }
$$
where the function $\Gamma$ defined in assumption $(SAEM4')$ and $J$ is the Jacobian matrix of the function $h$. 
Applying the Delta method, we get that:
$$
\sqrt{k}( Vect(\Phi_n(\bar{s}^k)) - Vect(\Phi_n(s^*))) \mathbb{1}_{\lim \| s^k-s^*\|=0 } \overset{\mathcal{L}}{ \rightarrow} W\mathbb{1}_{\lim \| s^k-s^*\|=0 }
$$
where $W \sim \mathcal{N}(0, \partial Vect(\Phi_n (s^*)) J(s^*)^{-1}  \Gamma(s^*) J(s^*)^{-1} \partial Vect(\Phi_n (s^*))^t )$ which leads to the result.
:::

Note that as usually in stochastic approximation results, the rate $\sqrt{k}$ is achieved when considering an average estimator (see Theorem 7 of [@Delyon1999] *e.g*). 

### Description of the algorithm for general latent variables models {#sec-generalmodel} 

In  general settings, the SAEM algorithm can yet  be applied to approximate numerically the maximum likelihood estimate of the model parameter. Nevertheless  there are no more theoretical garantees of convergence for the algorithm. However we propose an extended version of our algorithm which allows to get an estimate  of the Fisher information matrix as a by-product of the estimation algorithm. 


- **Initialization step**:  Initialize arbitrarily $\Delta_i^0$ for all $1 \leq i \leq n$, $Q_0$ and $\theta_0$. 
- **Repeat until convergence the three steps defined at iteration $k$ by**:
- **Simulation  step**:  for $1 \leq i \leq n$ simulate a realization  $Z_i^k$ from  the conditional distribution given the observations $Y_i$, $p_i$, using the current parameter $\theta_{k-1}$. 
- **Stochastic approximation step**: compute the quantities for all  $1 \leq i \leq n$
$$
Q_{k}(\theta) = (1-\gamma_k)Q_{k-1}(\theta)+\gamma_k \sum_{i=1}^n \log f(y_i,Z_i^k;\theta)
$$
$$
\Delta_i^{k} = (1-\gamma_k)\Delta_i^{k-1} +\gamma_k \partial_\theta \log f(y_i,Z_i^k;\theta_{k-1})
$$


- **Maximisation step**: update  of the parameter estimator  according to:
$$
\theta_{k} = \argmax_{\theta} Q_{k}(\theta).
$$

- **When convergence is reached, say  at iteration $K$ of the algorithm, evaluate  the FIM estimator according to**:
$$
I_{n,sco}^K = \frac{1}{n} \sum_{i=1}^n \Delta_i^K (\Delta_i^K )^t.
$$


We illustrate through simulations  in a nonlinear mixed effects model the performance of this algorithm in @sec-SimusNLMM.

# Simulation study {#sec-simul}

## Asymptotic properties of the estimators $I_{n,sco}(\theta)$ and $I_{n,obs}(\theta)$ 

In this section, we investigate the properties of the estimators $I_{n,sco}(\theta)$ and $I_{n,obs}(\theta)$ when the sample size $n$ grows. 

### Simulation settings

First  we consider the following linear mixed effects model $y_{ij} = \beta + z_{i} + \varepsilon_{ij},$
where $y_{ij} \in \mathbb{R}$ denotes the $j^{th}$ observation of individual $i$, $1\leq i \leq n$, $1\leq j \leq J$, $z_i \in \mathbb{R}$  the unobserved random effect of individual $i$ and $\varepsilon_{ij} \in \mathbb{R}$  the residual term. The random effects $(z_{i})$ are assumed independent and identically distributed such that $z_{i} \underset{i.i.d.}{\sim} \mathcal{N}(0,\eta^2)$, the residuals $(\varepsilon_{ij})$ are assumed independent and identically distributed such that $\varepsilon_{ij} \underset{i.i.d.}{\sim} \mathcal{N}(0,\sigma^2)$ and the sequences $(z_i)$ and $(\varepsilon_{ij})$ are assumed mutually independent. Here, the model parameters are $\theta = (\beta, \eta^2, \sigma^2)$. We set $\beta=3$, $\eta^2=2$, $\sigma^2=5$ and $J=12$.

Second we consider the following Poisson mixture model where the distribution of each observation $y_i$, $1\leq i \leq n$, depends on a state variable $z_i$ which is latent leading to
$y_i|z_i=k  \sim  \mathcal{P}(\lambda_k)$ with $P(z_i=k)  =  \alpha_k$ and $\sum_{k=1}^{K} \alpha_k  = 1.$
The model parameters are $\theta=(\lambda_1,\ldots,\lambda_K,\alpha_1,\ldots,\alpha_{K-1})$. For the simulation study, we consider a mixture of $K=3$ components, and the following values for the parameters $\lambda_1=2$, $\lambda_2=5$, $\lambda_3=9$, $\alpha_1=0.3$ and $\alpha_2=0.5$.


For each model, we generate $M=500$ datasets for different sample sizes $n \in \left\{20,100,500 \right\}$. As a first step, we assume that the true parameter values, denoted by $\theta^{\star}$, are known in order to investigate the asymptotic properties of both $I_{n,sco}$ and $I_{n,obs}$ without adding extra noise induced by the estimation of the parameters. Hence, for each value of $n$ and for each $1 \leq m \leq M$, we derive $I_{n,sco}^{(m)}(\theta^{\star})$ and $I_{n,obs}^{(m)}(\theta^{\star})$. The estimators $I_{n,sco}(\theta^{\star})$ and $I_{n,obs}(\theta^{\star})$ can be computed explicitly in both models by applying formula @eq-vnmis and Louis' formula [@Louis1982] (see R functions provided in the Appendix section). We then compute the empirical bias and the root mean squared deviation of each component $(\ell,\ell')$ of the estimated matrix as:
$$
\frac{1}{M} \sum\limits_{m=1}^{M} I_{n,sco,\ell,\ell'}^{(m)}(\theta^\star) - I_{\ell,\ell'}(\theta^\star)  \; \; \;  \mathrm{and} \; \; \; \sqrt{\frac{1}{M} \sum\limits_{m=1}^{M} \left(I_{n,sco,\ell,\ell'}^{(m)}(\theta^\star) - I_{\ell,\ell'}(\theta^\star)\right)^2}.
$$

In the previous quantities, $I(\theta^\star)$ is explicit in the linear mixed effects model and approximated by a Monte-Carlo estimation based on a sample of size $10^8$ in the Poisson mixture model. The results are presented in @tbl-BiasLMM and @tbl-SdLMM for the linear mixed effects model and in @tbl-BiasMixt and @tbl-SdMixt for the mixture model.
In a second step, we use the linear mixed effects model to look at what happens when the parameter $\theta$ is unknown and the estimation of the Fisher information matrix requires to compute an estimate $\hat{\theta}_n$. We use the datasets simulated with $n=500$ and we compute the $M=500$ asymptotic confidence intervals of the three model parameters. We then deduce empirical coverage rates for the following nominal rates $1-\alpha \in \{0.90, 0.95, 0.99\}$ by using the diagonal terms of either the inversed $I_{n,sco}^{(m)}(\theta^{\star})$ (resp. $I_{n,obs}^{(m)}(\theta^{\star})$) or the inversed $I_{n,sco}^{(m)}(\hat{\theta}_n)$ (resp. $I_{n,obs}^{(m)}(\hat{\theta}_n)$). The results are depicted in @tbl-coverageLMM-n100 and @tbl-coverageLMM-n500.

```{r}
#| label: simuLMM-functions
#| eval: false
#| echo: false
source('functions/Fisher_LMM.R')
source('functions/Isco_LMM.R')
source('functions/Iobs_LMM.R')
```

```{r}
#| label: simuLMM-FIM-sco-obs
#| echo: true
#| eval: false
#| message: false
#| file: scripts/simuLMM-estimFIM.R
```

```{r}
#| label: simuPoissonMixture-functions
#| eval: false
#| echo: false
source('functions/sim_poisson_mixture.R')
source('functions/em_poisson_mixture.R')
source('functions/fisher_estimation_poisson_mixture.R')
```


```{r}
#| label: simuPoissonMixture-exactFIM-MCMC
#| eval: false
#| file: scripts/simuPoissonMixture-exactFIM-MCMC.R
```

```{r}
#| label: simuPoissonMixture-FIM-sco-obs
#| echo: true
#| eval: false
#| file: scripts/simuPoissonMixture-estimFIM.R
```


### Results

From @tbl-BiasLMM, @tbl-SdLMM, @tbl-BiasMixt and @tbl-SdMixt, we observe that whatever the model and whatever the components of $I_{n,sco}(\theta^{\star})$ and $I_{n,obs}(\theta^{\star})$, the bias is very small even for small values of $n$. Note that in the linear mixed effects model the second derivative with respect to parameter $\beta$ is deterministic, which explains why the bias and the dispersion of the estimations $I_{n,obs}(\theta^{\star})$ are zero for every value of $n$. The bias and the standard deviation decrease as $n$ increases overall, which illustrates the consistency of both M-estimators. The distributions of the normalized estimations $\sqrt{n} \left(I_{n,sco}^{(m)}(\theta^\star) - I(\theta^\star)\right)$ and $\sqrt{n} \left(I_{n,obs}^{(m)}(\theta^\star) - I(\theta^\star)\right)$ are also represented when $n=500$ for some components of the matrices in @fig-simuLMM (linear mixed effects model) and @fig-simuPoissonMixture (Poisson mixture model). The empirical distributions have the shape of Gaussian distributions and illustrate the asymptotic normality of the two estimators. The numerical results highlight that neither $I_{n,sco}(\theta^{\star})$ nor $I_{n,obs}(\theta^{\star})$ is systematically better than the other one in terms of bias and asymptotic covariance matrix. In the same model, different behaviors can be observed depending on the components of the parameter vector.


```{r}
#| label: fig-simuLMM
#| echo: false
#| eval: true
#| fig-cap: Linear mixed effects model. Kernel density estimates of the normalized values of some components of the estimated Fisher information matrix based on the score (I n,sco) and of the observed Fisher information matrix (I n,obs) computed in the true parameter values from the 500 simulated datasets with n=500.
#| file: scripts/simuLMM-resPlots.R
```


```{r}
#| label: fig-simuPoissonMixture
#| echo: false
#| eval: true
#| fig-cap: Poisson mixture model. Kernel density estimates of the normalized values of some components of the estimated Fisher information matrix based on the score (I n,sco) and of the observed Fisher information matrix (I n,obs) computed in the true parameter values from the 500 simulated datasets with n=500.
#| file: scripts/simuPoissonMixture-resPlots.R
```


```{r}
#| label: tbl-BiasLMM
#| tbl-cap: Linear mixed effects model. Empirical bias to the Fisher Information matrix of Isco and Iobs computed in the true parameter values for different values of n.
#| echo: false
#| eval: true
#| warning: false
#| message: false
#| file: scripts/tableBiasLMM.R
```

```{r}
#| label: tbl-SdLMM
#| tbl-cap: Linear mixed effects model. Empirical squared deviation to the Fisher Information matrix of Isco and Iobs computed in the true parameter values for different values of n.
#| echo: false
#| eval: true
#| warning: false
#| message: false
#| file: scripts/tableSdLMM.R
```


```{r}
#| label: tbl-BiasMixt
#| tbl-cap: Poisson mixture model. Empirical bias to the Fisher Information matrix of Isco and Iobs computed in the true parameter values for different values of n.
#| echo: false
#| warning: false
#| message: false
#| file: scripts/tableBiasPoissonMixture.R
```

```{r}
#| label: tbl-SdMixt
#| tbl-cap: Poisson mixture model. Empirical squared deviation to the Fisher Information matrix of Isco and Iobs computed in the true parameter values for different values of n.
#| echo: false
#| warning: false
#| message: false
#| file: scripts/tableSdPoissonMixture.R
```

@tbl-coverageLMM-n100 and @tbl-coverageLMM-n500 show that the empirical coverage rates computed from $I_{n,sco}$ and $I_{n,obs}$ in the linear mixed effects model are close to the nominal values, which corroborates the relevance of both estimators. Moreover there is little difference between the results obtained when using $I_{n,sco}$ or $I_{n,obs}$ to estimate the Fisher information matrix. When the parameter value is unknown, the uncertainty related to the parameter estimation leads to a deterioration of the coverage rates. Still, this deterioration diminishes when $n$ increases.

```{r}
#| label: tbl-coverageLMM-n100
#| tbl-cap: Linear mixed effects model. Comparison of the coverage rates computed from both estimates of the Fisher information matrix in either the true or the estimated parameter values when n=100.
#| echo: false
#| warning: false
#| message: false
#| file: scripts/simuLMM-coverage-n100.R
```

```{r}
#| label: tbl-coverageLMM-n500
#| tbl-cap: Linear mixed effects model. Comparison of the coverage rates computed from both estimates of the Fisher information matrix in either the true or the estimated parameter values when n=500.
#| echo: false
#| warning: false
#| message: false
#| file: scripts/simuLMM-coverage-n500.R
```


# Conclusion and discussion


In this work, we address the estimation of the Fisher information matrix in general latent variable models. We focus on the empirical Fisher information matrix which is a moment estimate of the covariance matrix of the score.  We propose a stochastic approximation algorithm to compute this estimate when it can not be calculated analytically and establish its theoretical convergence properties. We carry out a simulation study in mixed effects model and in a Poisson mixture model to compare the performances of several estimates, namely the considered empirical Fisher information matrix and the observed  Fisher information matrix. We apply our methodology to real data which were fitted using a nonlinear mixed effects model.   We emphasize that the  empirical FIM requires less regularity assumptions than the  observed  FIM. From a computational point of view, the implementation of the algorithm for evaluating the empirical FIM only involves the first derivatives of the log-likelihood, in contrary to the one for evaluating the observed FIM which involves the second derivatives of the log-likelihood.

The main perspective of this work is to adapt the procedure for statistical models whose derivatives of the log-likelihood have no tractable expressions, coupling the algorithm with numerical derivative procedures. 


# Appendix

It is assumed that the random variables $s^0, z_1, z_2, \cdots$ are 
defined on the same probability space $(\Omega, \mathcal{A}, P)$. We denote $\mathcal{F} = \{ \mathcal{F}_k \}_{k \geq 0}$ the increasing family of 
$\sigma$-algebras generated by the random variables $s_0, z_1, z_2, \cdots, z_k$. We assume the following conditions:


- **(M1')** The parameter space $\Theta$ is an open subset of $\mathbb{R}^{p}$. The individual complete data likelihood function is given for all $i=1,\ldots,n$  by:
$$
f_i(z_i;\theta)
= \exp\left(-\psi_i(\theta) + \left<S_i(z_i),\phi_i(\theta)\right>\right),
$$
where  $\left<\cdot,\cdot\right>$ denotes the scalar product, $S_i$ is a Borel
function on $\mathbb{R}^{d_i}$  taking its values in an open subset $\mathcal{S}_i$ of $\mathbb{R}^{m_i}$. Moreover, the convex hull of $S(\mathbb{R}^{\sum d_i})$  is included in $\mathcal{S}$ and for all $\theta \in \Theta$ $\int S(z) \prod p_i(z_i;\theta) \mu(dz) < \infty$

- **(M2')** Define for each $i$ $L_i : \mathcal{S}_i \times \Theta \to \mathbb{R}$ as $L_i(s_i; \theta)\triangleq - \psi_i(\theta) + \left<s_i,\phi_i(\theta)\right>$.The functions $\psi_i$ and $\phi_i$ are twice 
continuously differentiable on $\Theta$. 

- **(M3)** The function $\bar{s} : \Theta \rightarrow \mathcal{S}$ defined as
$\bar{s}(\theta) \triangleq \int S(z) p(z; \theta) \mu(dz)$ is continuously differentiable on $\Theta$.

- **(M4)** The function $l:\Theta \rightarrow \mathbb{R}$ defined as 
$l(\theta) \triangleq \log g(\theta) = \log \int_{\mathbb{R}^{d_z}} f(z;\theta) \mu(dz)$ is continuously differentiable on $\Theta$ and $\partial_\theta \int f(z; \theta) \mu(dz)= \int \partial_\theta f(z; \theta)  \mu(dz)$.

- **(M5)** There exists a continuously differentiable function
$\widehat{\theta} : \ \mathcal{S} \rightarrow \Theta$, such that:
$$ 
\forall s \in \mathcal{S}, \ \  \forall \theta \in \Theta, \ \ 
L(s; \widehat{\theta}(s))\geq L(s; \theta).
$$ 


In addition, we define:

- **(SAEM1)** For all $k$ in $\mathbb{N}$, $\gamma_k \in [0,1]$, 
$\sum_{k=1}^\infty \gamma_k = \infty$ and  $\sum_{k=1}^\infty \gamma_k^2 < \infty$.

- **(SAEM2)**  $l:\Theta  \rightarrow  \mathbb{R}$ and  $\widehat{\theta} :  \mathcal{S} \rightarrow \Theta$ are $m$ times differentiable, where $m$ is the integer such that $\mathcal{S}$ is an open subset of $\mathbb{R}^m$. 

- **(SAEM3)** For all positive Borel functions $\Phi$ $E[ \Phi( z_{k+1}) | \mathcal{F}_k ] = \int \Phi( z  ) p ( z; \theta_k) \mu( dz).$

- **(SAEM4)** For all $\theta \in \Theta$, $\int \| S(z) \|^2 p( z; \theta) \mu (d z) < \infty$, and the function 
$$
\begin{split}
\Gamma(\theta) \triangleq \mathrm{Cov}_\theta [S(z)]\triangleq &\int
S(z)^t S(z) p(z;\theta)\mu(dz)\\
&-\left[\int S(z)p(z;\theta)\mu(dz)\right]^t\left[\int S(z)p(z;\theta)\mu(dz)\right]
\end{split}
$$
is continuous w.r.t. $\theta$.


We also define assumptions required for the normality result:

- **(SAEM1')** For all $k$ in $\mathbb{N}$, $\gamma_k \in [0,1]$, 
$\sum_{k=1}^\infty \gamma_k = \infty$ and  $\sum_{k=1}^\infty \gamma_k^2 < \infty$. There exists $\gamma^*$ such that $\lim k^\alpha /\gamma_k =\gamma^*$, and $\gamma_k / \gamma_{k+1}=1 + O(k^{-1})$.

- **(SAEM4')** For some $\alpha>0$, $\sup_\theta \mathrm{E}_\theta(\|S(Z)\|^{2+\alpha})< \infty$ and $\Gamma$ is continuous w.r.t. $\theta$.

- **(LOC1)** The stationary points of $l$ are isolated: any compact subset of $\Theta$ contains only a finite number of such points.

- **(LOC2)** For every stationary point $\theta^*$, the matrices $\mathrm{E}_\theta^*(\partial_\theta L(S(Z),\theta^*) (\partial_\theta L(S(Z),\theta^*))^t)$  and $\partial_\theta^2  L(\mathrm{E}_\theta^* (S(Z)),\theta^*)$ are positive definite.

- **(LOC3)** The minimum eigenvalue of the covariance matrix $R(\theta)=\mathrm{E}_\theta((S(Z)-\bar{s}(\theta))(S(Z)-\bar{s}(\theta))^t)$
is bounded away from zero for $\theta$ in any compact subset of $\Theta$.

## R functions

### Exact computation of the Fisher information matrix in the linear mixed effects model {#sec-R-exactFIMLMM}

```{r}
#| eval: true
#| file: functions/Fisher_LMM.R
#| label: LMM-exactFIM-function-show
```

### Fisher information matrix extimation in the linear mixed effects model {#sec-R-estFIMLMM}

```{r}
#| eval: true
#| file: functions/Isco_LMM.R
#| label: LMM-Isco-function-show
```

```{r}
#| eval: true
#| file: functions/Iobs_LMM.R
#| label: LMM-Iobs-function-show
```

### Fisher information matrix estimation in the Poisson mixture model {#sec-R-estFIMPoisson}

```{r}
#| eval: true
#| file: functions/fisher_estimation_poisson_mixture.R
#| label: simuPoissonMixture-function-show
```

### SAEM algorithm in the PK model belonging to the curved exponential family {#sec-R-saemNLMEexp}

```{r}
#| eval: true
#| file: functions/saem_nlme_exponential_bis.R
#| label: simuNlmeExp-function-show
```

### SAEM algorithm in the PK model not belonging to the curved exponential family {#sec-R-saemNLMEnonexp}

```{r}
#| eval: true
#| file: functions/saem_nlme_non_exponential.R
#| label: simuNlmeExp-function-show
```

### Fisher information matrix estimation in the Gaussian mixture model {#sec-R-estFIMGaussian}

```{r}
#| eval: true
#| file: functions/fisher_estimation_gaussian_mixture.R
#| label: simuGuassianMixture-function-show
```
